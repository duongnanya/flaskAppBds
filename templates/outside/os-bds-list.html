{% extends 'base.html' %}

{% block dnnScript %}
<script>

//--- Click Heart để lưu/quan tâm
// Kiểm tra trạng thái ban đầu của icon heart/heart-fill
$(".bds-favorite").each(function() {
  var bdsId = $(this).data("bds-id");
  checkFavoriteStatus(bdsId, $(this));
});

// Xử lý sự kiện click vào icon heart/heart-fill
$(".bds-favorite").click(function() {
  var bdsId = $(this).data("bds-id");
  var $icon = $(this);
  toggleFavoriteStatus(bdsId, $icon);
});

function toggleFavoriteStatus(bdsId, $icon) {
  $.ajax({
    url: "{{ url_for('bds.toggle_favorite', bds_id='-1') }}".replace("-1", bdsId),
    type: "POST",
    success: function(data) {
      if (data.success) {
        if (data.is_favorite) {
          $icon.removeClass("bi-heart").addClass("bi-heart-fill");
        } else {
          $icon.removeClass("bi-heart-fill").addClass("bi-heart");
        }
      } else {
        alert("Có lỗi xảy ra. Vui lòng thử lại.");
      }
    },
    error: function() {
      alert("Có lỗi xảy ra. Vui lòng thử lại.");
    }
  });
};

function checkFavoriteStatus(bdsId, $icon) {
  $.ajax({
    url: "{{ url_for('bds.check_favorite', bds_id='-1') }}".replace("-1", bdsId),
    type: "GET",
    success: function(data) {
      if (data.is_favorite) {
        $icon.removeClass("bi-heart").addClass("bi-heart-fill");
      } else {
        $icon.removeClass("bi-heart-fill").addClass("bi-heart");
      }
    },
    error: function() {
      alert("Có lỗi xảy ra. Vui lòng thử lại.");
    }
  });
};

//--- hiển thị tên Type được chọn trên Dropdown
var $dropdown = $('.dropdown');
var $button = $dropdown.find('#type-dropdown');
var $checkboxes = $dropdown.find('input[type="checkbox"]');

function updateButtonText() {
    var checkedCount = $dropdown.find('input[type="checkbox"]:checked').length;
    var firstCheckedLabel = $dropdown.find('input[type="checkbox"]:checked').first().siblings('label').text();

    if (checkedCount === 0) {
        $button.text('Chọn loại');
    } else if (checkedCount === 1) {
        $button.text(firstCheckedLabel);
    } else {
        $button.text(firstCheckedLabel + ' (+' + (checkedCount - 1) + ')');
    }
}

$checkboxes.on('change', function() {
    updateButtonText();
});

// Cập nhật nội dung của button ngay khi trang được load
updateButtonText();

//--- xử lý Find Tỉnh thành theo Keyword
// Khi dropdown button được nhấn
$('#dropdown-toggle-province').on('click', function() {
    // Focus vào ô keyword
    $('#keyword-province').focus();
    // Làm trống giá trị trong ô keyword
    $('#keyword-province').val('');
    // Hiện toàn bộ dropdown-item
    $('#dropdown-menu-province .dropdown-item-row').show();
});

// Xử lý khi người dùng nhập vào ô keyword
$('#keyword-province').on('input', function() {
    var keyword = $(this).val().toLowerCase();
    // Chuyển đổi keyword thành dạng không dấu và loại bỏ khoảng trắng để dễ so sánh
    var normalizedKeyword = keyword.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

    // Duyệt qua các dropdown-item
    $('#dropdown-menu-province .dropdown-item').each(function() {
        var itemText = $(this).text().toLowerCase();
        var normalizedItemText = itemText.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

        // Nếu keyword là rỗng hoặc trùng khớp với item text thì hiện item, ngược lại thì ẩn item
        if (normalizedKeyword === '' || normalizedItemText.includes(normalizedKeyword)) {
            $(this).parent().show();
        } else {
            $(this).parent().hide();
        }
    });
});

//--- click item Province thì gán tên Tỉnh vào Nút, update City tương ứng
$('#dropdown-menu-province .item-link').click(function() {
    // Lấy text và value
    var text = $(this).text();
    var provinceId = $(this).data('value');

    // Cập nhật text cho nút
    $('#dropdown-toggle-province').text(text);

    // Cập nhật value cho input hidden
    $('#province-select').val(provinceId);

    getCitiesByProvince(provinceId);
})

//--- xử lý Find City theo Keyword
// Khi dropdown button được nhấn
$('#dropdown-toggle-city').on('click', function() {
    // Focus vào ô keyword
    $('#keyword-city').focus();
    // Làm trống giá trị trong ô keyword
    $('#keyword-city').val('');
    // Hiện toàn bộ dropdown-item
    $('#dropdown-menu-city .dropdown-item-row').show();
});

//--- click item City thì gán tên City vào Nút 
$('#dropdown-menu-city .item-link').click(function() {
    // Lấy text và value
    var text = $(this).text();
    var cityId = $(this).data('value');

    // Cập nhật text cho nút
    $('#dropdown-toggle-city').text(text);

    // Cập nhật value cho input hidden
    $('#city-select').val(cityId);
})

//--- Tìm Cities tương ứng Provinces
function getCitiesByProvince(provinceId) {
    if (provinceId) {
        // Ajax call lấy cities
        $.ajax({
            url: '{{ url_for("bds.get_cities", province_id=999) }}'.replace('999', provinceId),
            type: 'GET',
            success: function(data) {
                // Lấy dropdown menu của city
                var cityDropdownMenu = $('#dropdown-menu-city'); 
                cityDropdownMenu.empty(); // Xóa các mục hiện có

                // Thêm input tìm kiếm
                cityDropdownMenu.append(`
                    <li>
                        <div class="container">
                            <div class="col-12">
                                <input type="text" class="form-control col-6" id="keyword-city" placeholder="keyword" aria-label="keyword" aria-describedby="addon-wrapping">
                            </div>
                        </div>
                    </li>
                `);

                // Thêm các mục city vào dropdown
                $.each(data, function(index, city) {
                    cityDropdownMenu.append(`
                        <li class="dropdown-item-row">
                            <a class="dropdown-item item-link-city" data-value="${city.id}">${city.name}</a>
                        </li>
                    `);
                });

                // Bật dropdown city và cập nhật nút
                $('#dropdown-toggle-city').prop('disabled', false).text('Quận/Huyện');

                // Xử lý khi click vào item city mới được thêm
                $('.item-link-city').click(function() {
                    var selectedCityName = $(this).text();
                    var selectedCityId = $(this).data('value');
                    $('#dropdown-toggle-city').text(selectedCityName);
                    $('#city-select').val(selectedCityId); // Cập nhật giá trị vào input ẩn
                });

                // Kiểm tra selectedCityId và cập nhật dropdown
                var selectedCityId = "{{ selected_city_id }}";
                if (selectedCityId && data.some(city => city.id == selectedCityId)) {
                    // Tìm item có ID trùng với selectedCityId
                    var selectedCity = data.find(city => city.id == selectedCityId);
                    $('#dropdown-toggle-city').text(selectedCity.name);
                    $('#city-select').val(selectedCityId);
                } else {
                    // Nếu selectedCityId không hợp lệ, gán tên item đầu tiên vào nút dropdown và cập nhật giá trị vào input ẩn
                    if (data.length > 0) {
                        $('#dropdown-toggle-city').text(data[0].name);
                        $('#city-select').val(data[0].id); // Cập nhật giá trị vào input ẩn
                    }
                }

                // Thêm event listener cho #keyword-city sau khi AJAX hoàn thành
                $('#keyword-city').on('input', function() {
                    var keyword = $(this).val().toLowerCase();
                    // Chuyển đổi keyword thành dạng không dấu và loại bỏ khoảng trắng để dễ so sánh
                    var normalizedKeyword = keyword.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

                    // Duyệt qua các dropdown-item
                    $('#dropdown-menu-city .dropdown-item').each(function() {
                        var itemText = $(this).text().toLowerCase();
                        var normalizedItemText = itemText.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

                        // Nếu keyword là rỗng hoặc trùng khớp với item text thì hiện item, ngược lại thì ẩn item
                        if (normalizedKeyword === '' || normalizedItemText.includes(normalizedKeyword)) {
                            $(this).parent().show();
                        } else {
                            $(this).parent().hide();
                        }
                    });
                });
            }
        });
    } else {
        // Xóa dữ liệu và vô hiệu hóa dropdown city
        $('#dropdown-menu-city').empty();
        $('#dropdown-toggle-city').prop('disabled', true).text('Quận/Huyện'); 
    }
}

//--- khi load trang, cập nhật tên Nút thành tên của Tỉnh có value từ hidden (có từ lần search trước)
var selectedProvinceId = "{{ selected_province_id }}";
var selectedCityId = "{{ selected_city_id }}";

// Delay the execution by 1 millisecond
setTimeout(function() {
    // Tìm kiếm item có data-value trùng với selectedProvinceId
    var selectedProvinceItem = $('.item-link[data-value="' + selectedProvinceId + '"]');

    // Nếu tìm thấy item
    if (selectedProvinceItem.length > 0) {
        // Lấy tên tỉnh từ item đã chọn
        var selectedProvinceName = selectedProvinceItem.text();

        // Cập nhật tên nút
        $('#dropdown-toggle-province').text(selectedProvinceName);
    }

    getCitiesByProvince(selectedProvinceId);
}, 1); // 1 millisecond delay

//--- Cập nhật giá trị ban đầu khi trang được tải
setTimeout(function() {
  updateProvinceCitySelect();
}, 1); // 1 millisecond delay

// Hàm cập nhật giá trị của #province-select, #city-select
function updateProvinceCitySelect() {
    var selectedProvinceId = "{{ selected_province_id }}";
    $('#province-select').val(selectedProvinceId);

    getCitiesByProvince(selectedProvinceId);
}
</script>
{% endblock %}

{% block title %}Danh sách Bds{% endblock %}

{% block content %}
<div class="container os-bds-list-html">
  <div class="row">
    <div class="col-md-12">
      <h1>Danh sách Bds</h1>
    </div>
  </div>
  <form action="{{ url_for('bds.os_bds_list') }}" method="POST" class="mb-3">
    <input type="hidden" name="province-select" id="province-select" val="{{ selected_province_id }}">
    <input type="hidden" name="city-select" id="city-select" val="{{ selected_city_id }}">
    <div class="row mb-3">
        <div class="col-3">
          <div class="dropdown">
              <button type="button" class="btn btn-outline-secondary dropdown-toggle col-12" id="type-dropdown" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                Chọn loại
              </button>
              <div class="dropdown-menu p-4 col-12">
                  <p>(Có thể chọn nhiều)</p>
                  <ul class="list-group">
                    {% for type in types %}
                    <li class="list-group-item">
                        <input class="form-check-input me-1" type="checkbox" name="type-id[]" value="{{ type.id }}" id="type-{{ type.id }}"
                        {% if type.id|string in selected_type_ids %}checked{% endif %}>
                        <label class="form-check-label" for="type-{{ type.id }}">{{ type.name }}</label>
                    </li>
                    {% endfor %}
                </ul>
              </div>
          </div>
        </div>
        <div class="col-3">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle col-12" id="dropdown-toggle-province"
                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Tỉnh/Thành phố
            </button>
            <ul class="dropdown-menu col-12" id="dropdown-menu-province">
              <li>
                <div class="container">
                  <div class="col-12">
                    <input type="text" class="form-control col-6" id="keyword-province"
                            placeholder="từ khóa" aria-label="keyword" aria-describedby="addon-wrapping">
                  </div>
                </div>
              </li>
              {% for province in provinces %}
              <li class="dropdown-item-row">
                <a class="dropdown-item item-link" data-value="{{ province.id }}">{{ province.name }}</a>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <div class="col-3">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle col-12" id="dropdown-toggle-city" 
                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Quận/Huyện
            </button>
            <ul class="dropdown-menu col-12" id="dropdown-menu-city">
              <li>
                <div class="container">
                  <div class="col-12">
                    <input type="text" class="form-control col-6" id="keyword-city" 
                           placeholder="từ khóa" aria-label="keyword" aria-describedby="addon-wrapping">
                  </div>
                </div>
              </li>
              {% for city in cities %}
              <li class="dropdown-item-row">
                <a class="dropdown-item item-link-city" data-value="{{ city.id }}">{{ city.name }}</a>
              </li>
              {% endfor %}
            </ul>
          </div>
          <input type="hidden" name="city-select" id="city-select" value="{{ selected_city_id }}"> 
        </div>
        <div class="col-3">
            <div class="input-group">
              <input type="text" class="form-control" name="address-text" placeholder="Tên Đường/phố" aria-label="Search" value="{{ address }}">
            </div>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-3">
            <label for="pricerange-select" class="form-label">Mức giá:</label>
            <select class="form-control" name="price-range-select" id="price-range-select">
                <option value="">- Chọn mức giá -</option>
                {% for priceRange in priceRanges %}
                <option value="{{ priceRange.id }}" {% if selected_price_range_id == priceRange.id|string %}selected{% endif %}>{{ priceRange.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-3">
            <label for="arearange-select" class="form-label">Diện tích:</label>
            <select class="form-control" name="area-range-select" id="area-range-select">
                <option value="">- Chọn diện tích -</option>
                {% for areaRange in areaRanges %}
                <option value="{{ areaRange.id }}" {% if selected_area_range_id == areaRange.id|string %}selected{% endif %}>{{ areaRange.name }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- <div class="col-3">
            <label for="direction-select" class="form-label">Hướng:</label>
            <select class="form-control" name="direction-select" id="direction-select">
                <option value="">- Chọn hướng -</option>
                {% for direction in directions %}
                <option value="{{ direction.id }}" {% if selected_direction_id == direction.id|string %}selected{% endif %}>{{ direction.name }}</option>
                {% endfor %}
            </select>
        </div> -->
        <div class="col-3">
          <button class="btn btn-primary" type="submit">Tìm kiếm</button>
          <button class="btn btn-secondary" type="submit" formaction="{{ url_for('contact.send_request') }}">Đề nghị tìm kiếm</button>
        </div>
    </div>
  </form>

  <div class="row">
    {% if bds_data %}
    {% for bds_item in bds_data %}
    <div class="col-md-3 mb-4">
      <div class="card h-100">
        <div class="card-img-top-wrapper position-relative">
          {% if bds_item.first_image_url %}
          <img src="{{ bds_item.first_image_url }}" class="card-img-top" alt="{{ bds_item.bds.title }}">
          {% else %}
          <img src="{{ url_for('static', filename='uploads/no-image.jpg') }}" class="card-img-top" alt="No Image">
          {% endif %}
          {% if bds_item.remaining_images_count > 0 %}
          <div class="position-absolute top-0 end-0 mt-3 me-4">
            <span class="badge bg-primary">+{{ bds_item.remaining_images_count }}</span>
          </div>
          {% endif %}
          <div class="position-absolute bottom-0 end-0 mb-3 me-4">
            <i class="bi {% if bds_item.is_favorite %}bi-heart-fill{% else %}bi-heart{% endif %} bds-favorite text-danger"
                style="font-size: 1.5rem;" data-bds-id="{{ bds_item.bds.id }}">
            </i>
          </div>
        </div>
        <div class="card-body">
          <a href="{{ url_for('bds.bds_detail', bds_id=bds_item.bds.id) }}">
            <h5 class="card-title">{{ bds_item.bds.title }}</h5>
          </a>
          <p class="card-text">
            ({{ bds_item.bds_types|count }})
            {% for bds_type in bds_item.bds_types %}
                {{ bds_type.name }}{% if not loop.last %} / {% endif %}
            {% endfor %}<br>
            {{ bds_item.price_to }} / {{ bds_item.bds.area }} m²<br>
            {{ bds_item.bds_city.name }}, {{ bds_item.bds_province.name }}
          </p>
        </div>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-md-12 mb-4">Không có BĐS phù hợp</div>
    {% endif %}
  </div>
</div>
{% endblock %}