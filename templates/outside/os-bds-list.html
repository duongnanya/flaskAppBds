{% extends 'base.html' %}

{% block dnnScript %}
<script>

//--- Click Heart để lưu/quan tâm
// Kiểm tra trạng thái ban đầu của icon heart/heart-fill
$(".bds-favorite").each(function() {
  var bdsId = $(this).data("bds-id");
  checkFavoriteStatus(bdsId, $(this));
});

// Xử lý sự kiện click vào icon heart/heart-fill
$(".bds-favorite").click(function() {
  var bdsId = $(this).data("bds-id");
  var $icon = $(this);
  toggleFavoriteStatus(bdsId, $icon);
});

function toggleFavoriteStatus(bdsId, $icon) {
  $.ajax({
    url: "{{ url_for('bds.toggle_favorite', bds_id='-1') }}".replace("-1", bdsId),
    type: "POST",
    success: function(data) {
      if (data.success) {
        if (data.is_favorite) {
          $icon.removeClass("bi-heart").addClass("bi-heart-fill");
        } else {
          $icon.removeClass("bi-heart-fill").addClass("bi-heart");
        }
      } else {
        alert("Có lỗi xảy ra. Vui lòng thử lại.");
      }
    },
    error: function() {
      alert("Có lỗi xảy ra. Vui lòng thử lại.");
    }
  });
};

function checkFavoriteStatus(bdsId, $icon) {
  $.ajax({
    url: "{{ url_for('bds.check_favorite', bds_id='-1') }}".replace("-1", bdsId),
    type: "GET",
    success: function(data) {
      if (data.is_favorite) {
        $icon.removeClass("bi-heart").addClass("bi-heart-fill");
      } else {
        $icon.removeClass("bi-heart-fill").addClass("bi-heart");
      }
    },
    error: function() {
      alert("Có lỗi xảy ra. Vui lòng thử lại.");
    }
  });
};

//--- hiển thị tên Type được chọn trên Dropdown
var $dropdown = $('.dropdown');
var $button = $dropdown.find('#type-dropdown');
var $checkboxes = $dropdown.find('input[type="checkbox"]');

function updateButtonText() {
    var checkedCount = $dropdown.find('input[type="checkbox"]:checked').length;
    var firstCheckedLabel = $dropdown.find('input[type="checkbox"]:checked').first().siblings('label').text();

    if (checkedCount === 0) {
        $button.text('Loại BĐS');
    } else if (checkedCount === 1) {
        $button.text(firstCheckedLabel);
    } else {
        $button.text(firstCheckedLabel + ' (+' + (checkedCount - 1) + ')');
    }
}

$checkboxes.on('change', function() {
    updateButtonText();
});

// Cập nhật nội dung của button ngay khi trang được load
updateButtonText();

//--- xử lý Find Tỉnh thành theo Keyword
// Khi dropdown button được nhấn
$('#dropdown-toggle-province').on('click', function() {
    // Focus vào ô keyword
    $('#keyword-province').focus();
    // Làm trống giá trị trong ô keyword
    $('#keyword-province').val('');
    // Hiện toàn bộ dropdown-item
    $('#dropdown-menu-province .dropdown-item-row').show();
});

// Xử lý khi người dùng nhập vào ô keyword
$('#keyword-province').on('input', function() {
    var keyword = $(this).val().toLowerCase();
    // Chuyển đổi keyword thành dạng không dấu và loại bỏ khoảng trắng để dễ so sánh
    var normalizedKeyword = keyword.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

    // Duyệt qua các dropdown-item
    $('#dropdown-menu-province .dropdown-item').each(function() {
        var itemText = $(this).text().toLowerCase();
        var normalizedItemText = itemText.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

        // Nếu keyword là rỗng hoặc trùng khớp với item text thì hiện item, ngược lại thì ẩn item
        if (normalizedKeyword === '' || normalizedItemText.includes(normalizedKeyword)) {
            $(this).parent().show();
        } else {
            $(this).parent().hide();
        }
    });
});

// --- click item Province thì gán tên Tỉnh vào Nút, update City tương ứng
$('#dropdown-menu-province .item-link-province').click(function() {
  var text = $(this).text();
  var provinceId = $(this).data('value');

  $('#dropdown-toggle-province').text(text);
  $('input[type=hidden][id=province-select]').val(provinceId).trigger('change');
});

// --- Xử lý khi input hidden #province-select thay đổi
$('input[type=hidden][id=province-select]').on('change', function() {
  var provinceId = $(this).val();

  // Kiểm tra nếu provinceId = 0
  if (provinceId === '0' || provinceId === 0) { 
    // Reset dropdown Province
    $('#dropdown-toggle-province').text(' Tỉnh/Thành phố ');

    // Reset dropdown City
    $('#dropdown-toggle-city').text(' Quận/Huyện ').prop('disabled', true); 
    $('#dropdown-menu-city').empty(); // Xóa danh sách city hiện tại (nếu có)

    // Reset #city-select về 0
    $('#city-select').val('0'); 
  } else {
    getCitiesByProvince(provinceId);
  }

  // Cập nhật class cho dropdown button
  updateDropdownButtonClasses();
});

// --- Sử dụng event delegation để bắt sự kiện click trên item-link-city
$('#dropdown-menu-city').on('click', '.item-link-city', function() {
  var text = $(this).text();
  var cityId = $(this).data('value');

  $('#dropdown-toggle-city').text(text);
  $('input[type=hidden][id=city-select]').val(cityId).trigger('change');
});

// --- Xử lý khi input hidden #city-select thay đổi
$('input[type=hidden][id=city-select]').on('change', function() {
  var cityId = $(this).val();

  // Cập nhật class cho dropdown button
  updateDropdownButtonClasses();
});

// Hàm cập nhật class cho dropdown button
function updateDropdownButtonClasses() {
  var provinceId = $('#province-select').val();
  var cityId = $('#city-select').val();

  // Kiểm tra giá trị của provinceId và cityId
  if (provinceId && provinceId !== '0' && provinceId !== 'None' 
      && cityId && cityId !== '0' && cityId !== 'None') {
    // Thêm btn-secondary, bỏ btn-outline-secondary
    $('#dropdown-toggle-province, #dropdown-toggle-city').addClass('btn-secondary').removeClass('btn-outline-secondary');
  } else {
    // Thêm btn-outline-secondary, bỏ btn-secondary
    $('#dropdown-toggle-province, #dropdown-toggle-city').addClass('btn-outline-secondary').removeClass('btn-secondary');
  }
}

// --- Tìm Cities tương ứng Provinces
function getCitiesByProvince(provinceId) {
  if (provinceId) {
    $.ajax({
      url: '{{ url_for("bds.get_cities", province_id=999) }}'.replace('999', provinceId),
      type: 'GET',
      success: function(data) {
        var cityDropdownMenu = $('#dropdown-menu-city');
        cityDropdownMenu.empty();

        // Thêm input tìm kiếm
        cityDropdownMenu.append(`
                  <li>
                      <div class="container">
                          <div class="col-12">
                              <input type="text" class="form-control col-6" id="keyword-city" placeholder="từ khóa" aria-label="keyword" aria-describedby="addon-wrapping">
                          </div>
                      </div>
                  </li>
              `);

        $.each(data, function(index, city) {
          cityDropdownMenu.append(`
                      <li class="dropdown-item-row">
                          <a class="dropdown-item item-link-city" data-value="${city.id}">${city.name}</a>
                      </li>
                  `);
        });

        $('#dropdown-toggle-city').prop('disabled', false).text(' Quận/Huyện ');

        // --- Sau khi thêm các mục city vào dropdown
        if (data.length > 0) {
          // **Lấy text và value của item đầu tiên**
          var firstCityText = data[0].name;
          var firstCityId = data[0].id;

          // **Gán giá trị cho #city-select trước**
          $('#city-select').val(firstCityId); 

          // **Bây giờ mới kiểm tra selectedCityId**
          var selectedCityId = $('#city-select').val();
          if (selectedCityId) { 
            // Cập nhật text cho dropdown button 
            $('#dropdown-toggle-city').text(firstCityText);
            // Trigger change event (nếu cần)
            $('#city-select').trigger('change'); 
          }
        }

        // --- Xử lý tìm kiếm city (giữ nguyên)
        $('#keyword-city').on('input', function() {
          var keyword = $(this).val().toLowerCase();
          var normalizedKeyword = keyword.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

          $('#dropdown-menu-city .dropdown-item').each(function() {
            var itemText = $(this).text().toLowerCase();
            var normalizedItemText = itemText.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '');

            if (normalizedKeyword === '' || normalizedItemText.includes(normalizedKeyword)) {
              $(this).parent().show();
            } else {
              $(this).parent().hide();
            }
          });
        });
      }
    });
  } else {
    $('#dropdown-menu-city').empty();
    $('#dropdown-toggle-city').prop('disabled', true).text(' Quận/Huyện ');
  }
}

// --- khi load trang, cập nhật tên Nút thành tên của Tỉnh/Thành phố có value từ hidden (giữ nguyên)
var selectedProvinceId = "{{ selected_province_id }}";
var selectedCityId = "{{ selected_city_id }}";

setTimeout(function() {
  if (selectedProvinceId) {
    var selectedProvinceItem = $('.item-link-province[data-value="' + selectedProvinceId + '"]');
    if (selectedProvinceItem.length > 0) {
      var selectedProvinceName = selectedProvinceItem.text();
      $('#dropdown-toggle-province').text(selectedProvinceName);
    }
    $('input[type=hidden][id=province-select]').val(selectedProvinceId).trigger('change');
  }

  if (selectedCityId) {
    var selectedCityItem = $('.item-link-city[data-value="' + selectedCityId + '"]');
    if (selectedCityItem.length > 0) {
      var selectedCityName = selectedCityItem.text();
      $('#dropdown-toggle-city').text(selectedCityName);
    }
    $('input[type=hidden][id=city-select]').val(selectedCityId).trigger('change');
  }
}, 1);
</script>
{% endblock %}

{% block title %}Danh sách Bds{% endblock %}

{% block content %}
<div class="container os-bds-list-html">
  <div class="row">
    <div class="col-12">
      <h1>Danh sách Bds</h1>
    </div>
  </div>
  <form action="{{ url_for('bds.os_bds_list') }}" method="POST" class="mb-3">
    <input type="hidden" name="province-select" id="province-select"
            value="{% if selected_province_id %}{{ selected_province_id }}{% else %}0{% endif %}">
    <input type="hidden" name="city-select" id="city-select"
            value="{{ selected_city_id }}">
    <div class="row mb-3">
        <div class="col-3">
          <div class="dropdown">
              <button type="button" class="btn btn-outline-secondary dropdown-toggle col-12" id="type-dropdown" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                Loại BĐS
              </button>
              <div class="dropdown-menu p-1 col-12">
                  <p>(Có thể chọn nhiều)</p>
                  <ul class="list-group">
                    {% for type in types %}
                    <li class="list-group-item p-2">
                        <input class="form-check-input me-1" type="checkbox" name="type-id[]" value="{{ type.id }}" id="type-{{ type.id }}"
                        {% if type.id|string in selected_type_ids %}checked{% endif %}>
                        <label class="form-check-label" for="type-{{ type.id }}">{{ type.name }}</label>
                    </li>
                    {% endfor %}
                </ul>
              </div>
          </div>
        </div>
        <div class="col-3">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle col-12" id="dropdown-toggle-province"
                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Tỉnh/Thành phố
            </button>
            <ul class="dropdown-menu col-12" id="dropdown-menu-province">
                <li>
                    <div class="container">
                        <div class="col-12">
                            <input type="text" class="form-control col-6" id="keyword-province"
                                   placeholder="từ khóa" aria-label="keyword" aria-describedby="addon-wrapping">
                        </div>
                    </div>
                </li>
                <li class="dropdown-item-row">
                    <a class="dropdown-item item-link-province" data-value="0">- Xóa chọn -</a>
                </li>
                {% for province in provinces %}
                <li class="dropdown-item-row">
                    <a class="dropdown-item item-link-province" data-value="{{ province.id }}">{{ province.name }}</a>
                </li>
                {% endfor %}
            </ul>
        </div>
        </div>
        <div class="col-3">
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle col-12" id="dropdown-toggle-city" 
                    type="button" data-bs-toggle="dropdown" aria-expanded="false" disabled>
              Quận/Huyện
            </button>
            <ul class="dropdown-menu col-12" id="dropdown-menu-city">
              <li>
                <div class="container">
                  <div class="col-12">
                    <input type="text" class="form-control col-6" id="keyword-city" 
                           placeholder="từ khóa" aria-label="keyword" aria-describedby="addon-wrapping">
                  </div>
                </div>
              </li>
              {% for city in cities %}
              <li class="dropdown-item-row">
                <a class="dropdown-item item-link-city" data-value="{{ city.id }}">{{ city.name }}</a>
              </li>
              {% endfor %}
            </ul>
          </div>
          <input type="hidden" name="city-select" id="city-select" value="{{ selected_city_id }}"> 
        </div>
        <div class="col-3">
            <div class="input-group">
              <input type="text" class="form-control" name="address-text" placeholder="Tên Đường/phố" aria-label="Search" value="{{ address }}">
            </div>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-3">
            <select class="form-control" name="price-range-select" id="price-range-select">
                <option value="">- Mức giá -</option>
                {% for priceRange in priceRanges %}
                <option value="{{ priceRange.id }}" {% if selected_price_range_id == priceRange.id|string %}selected{% endif %}>{{ priceRange.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-3">
            <select class="form-control" name="area-range-select" id="area-range-select">
                <option value="">- Diện tích -</option>
                {% for areaRange in areaRanges %}
                <option value="{{ areaRange.id }}" {% if selected_area_range_id == areaRange.id|string %}selected{% endif %}>{{ areaRange.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-3">
          <button class="btn btn-primary" type="submit">Tìm kiếm</button>
          <button class="btn btn-secondary" type="submit" formaction="{{ url_for('contact.contact') }}">Yêu cầu tìm kiếm</button>
        </div>
    </div>
  </form>

  <div class="row">
    {% if bds_data %}
    {% for bds_item in bds_data %}
    <div class="col-3 mb-4">
      <div class="card h-100">
        <div class="card-img-top-wrapper position-relative">
          {% if bds_item.first_image_url %}
          <img src="{{ bds_item.first_image_url }}" class="card-img-top" alt="{{ bds_item.bds.title }}">
          {% else %}
          <img src="{{ url_for('static', filename='uploads/no-image.jpg') }}" class="card-img-top" alt="No Image">
          {% endif %}
          {% if bds_item.remaining_images_count > 0 %}
          <div class="position-absolute top-0 end-0 mt-3 me-4">
            <span class="badge bg-primary">+{{ bds_item.remaining_images_count }}</span>
          </div>
          {% endif %}
          <div class="position-absolute bottom-0 end-0 mb-3 me-4">
            <i class="bi {% if bds_item.is_favorite %}bi-heart-fill{% else %}bi-heart{% endif %} bds-favorite text-danger"
                style="font-size: 1.5rem;" data-bds-id="{{ bds_item.bds.id }}">
            </i>
          </div>
        </div>
        <div class="card-body">
          <a href="{{ url_for('bds.bds_detail', bds_id=bds_item.bds.id) }}">
            <h5 class="card-title">{{ bds_item.bds.title }}</h5>
          </a>
          <p class="card-text">
            ({{ bds_item.bds_types|count }})
            {% for bds_type in bds_item.bds_types %}
                {{ bds_type.name }}{% if not loop.last %} / {% endif %}
            {% endfor %}<br>
            {{ bds_item.price_to }} / {{ bds_item.bds.area }} m²<br>
            {{ bds_item.bds_city.name }}, {{ bds_item.bds_province.name }}
          </p>
        </div>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-12 mb-4">Không có BĐS phù hợp</div>
    {% endif %}
  </div>
</div>
{% endblock %}